<!doctype html>
<html>
<head>
	<script type="text/javascript" src="js/required.js"></script>
    <script type="text/javascript" src='js/lib/pixi.min.js'></script>
    <script type="text/javascript" src="js/cljs/main.js"></script>
    <script type="text/javascript" src="js/components/standard.js"></script>
    <script type="text/javascript" src="js/components/pixi/pixi.js"></script>
    <script type="text/javascript" src="js/components/pixi/sprite.js"></script>
    <script type="text/javascript" src="js/components/pixi/movie.js"></script>
    <script type="text/javascript" src="js/components/joegrid.js"></script>

    <link href="css/ce.css" type="text/css" rel="stylesheet">
</head>
<body>
<script type="text/javascript" src="js/Constants.js"></script>
<script>

    E.mandate(C.new.transform);

    C("background",
      {instance:false,
       source: false,
       cached: false},

      {init: function(c){
          c.instance = new PIXI.ParticleContainer;
      },

       mount: function(c){
           c.source = c.owner.grid;
           c.source.mapindexed(function(i, x, y){
              c.source.data[i] = parseInt(Math.random()*10)
           });
           c.source.mapindexed(function(i, x, y){
               tile = new PIXI.Sprite(PIXI.Texture.fromFrame(c.source.data[i] + 25));
               tile.position.x = x * 32;
               tile.position.y = y * 32;
               c.instance.addChild(tile);
           })
       },
       update: function(c){
           root.pixi.renderer.render(c.instance);
       }
      });


    C("actor",
      {name: ""},
      {init: function(c){
          c.name = c.owner.name || "none";
          c.owner.transform.position.x = Math.random() * 600;
          c.owner.transform.position.y = Math.random() * 400;}})


    C("wander", {speed:2},
      {update: function(c){
          c.owner.transform.position.x += Math.random() * c.speed - 0.5 * c.speed;
          c.owner.transform.position.y += Math.random() * c.speed - 0.5 * c.speed; }});

    C("protoreport", {},
      {init: function(c){console.log(c.owner + " init");},
       mount: function(c){console.log(c.owner + " mount");},
       unmount: function(c){console.log(c.owner + " unmount");},
       destroy: function(c){console.log(c.owner + " destroy");}})

    makeActor = function(name){
        return E(name,
                C.new.actor(),
                C.new.sprite({image: "assets/sprites/objects/alphasquare.png"}),
                C.new.wander(),
                C.new.protoreport());
    }



    root =
        E("game",
          C.new.pixi({width:1400,height:900}),
          C.new.loop(),
          C.new.protoreport());

    map = E("map",
            C.new.grid({width:200,height:160}),
            C.new.background(),
            C.new.protoreport())

    root.add(map);

    root.add(E("people",
               makeActor("Joe"),
               C.new.protoreport()));



    PIXI.loader
      .add('assets/atlas.png')
      .add('assets/atlas.json')
      .load(function(){
        console.log("assets loaded");

        E.mount(root);
      });


</script>
</body>
</html>

